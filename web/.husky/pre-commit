#!/bin/sh
# get the list of modified files
files=$(git diff --cached --name-only)

# check if api or web directory is modified

api_modified=false
web_modified=false

for file in $files
do
    # Use POSIX compliant pattern matching
    case "$file" in
        api/*.py)
            # set api_modified flag to true
            api_modified=true
            ;;
        web/*)
            # set web_modified flag to true
            web_modified=true
            ;;
    esac
done

# run linters based on the modified modules

if $api_modified; then
    echo "Running Ruff linter on api module"

    # run Ruff linter auto-fixing
    uv run --project api --dev ruff check --fix ./api

    # run Ruff linter checks
    uv run --project api --dev ruff check ./api || status=$?

    status=${status:-0}

    if [ $status -ne 0 ]; then
      echo "Ruff linter on api module error, exit code: $status"
      echo "Please run ruff to fix the fixable linting errors."
      exit 1
    fi

    echo "Running mypy type checking on api module"

    # run mypy type checking (must run from api directory for Pydantic plugin to work correctly)
    # use subshell to isolate directory change for safety
    (cd api && uv run --dev mypy .) || status=$?

    status=${status:-0}

    if [ $status -ne 0 ]; then
      echo "Mypy type checking on api module failed, exit code: $status"
      echo "Please fix the type errors before committing."
      exit 1
    fi
fi

if $web_modified; then
    echo "Running lint-staged on web module"
    cd ./web || exit 1
    lint-staged
    cd ../
fi
