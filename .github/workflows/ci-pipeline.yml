name: CI Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read
  actions: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ════════════════════════════════════════════════════════════
  # Stage 0: Change Detection
  # ════════════════════════════════════════════════════════════
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.detect.outputs.backend }}
      frontend: ${{ steps.detect.outputs.frontend }}
      workflows: ${{ steps.detect.outputs.workflows }}
      migrations: ${{ steps.detect.outputs.migrations }}
      env-examples: ${{ steps.detect.outputs.env-examples }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed files
        id: changed
        uses: tj-actions/changed-files@v46

      - name: Compute change flags
        id: detect
        env:
          CHANGED_FILES: ${{ steps.changed.outputs.all_changed_files }}
        run: |
          python - <<'PY' >> "$GITHUB_OUTPUT"
          import os
          import shlex

          files = shlex.split(os.environ.get("CHANGED_FILES", ""))

          backend = any(
              f.startswith("api/")
              or f in {"pyproject.toml", "uv.lock"}
              for f in files
          )

          frontend = any(
              f.startswith("web/")
              and not f.startswith("web/messages/")
              for f in files
          )

          workflows = any(
              f.startswith(".github/workflows/")
              or f.startswith(".github/actions/")
              for f in files
          )

          migrations = any(
              f.startswith("api/migrations/")
              for f in files
          )

          env_examples = any(
              f in {"api/.env.example", "web/.env.example"}
              for f in files
          )

          print(f"backend={'true' if backend else 'false'}")
          print(f"frontend={'true' if frontend else 'false'}")
          print(f"workflows={'true' if workflows else 'false'}")
          print(f"migrations={'true' if migrations else 'false'}")
          print(f"env-examples={'true' if env_examples else 'false'}")
          PY

  # ════════════════════════════════════════════════════════════
  # Stage 1: Quality Gate (Parallel)
  # ════════════════════════════════════════════════════════════
  backend-quality:
    name: Backend Quality
    needs: detect-changes
    if: needs.detect-changes.outputs.backend == 'true'
    uses: ./.github/workflows/_reusable-quality-backend.yml
    secrets: inherit

  frontend-quality:
    name: Frontend Quality
    needs: detect-changes
    if: needs.detect-changes.outputs.frontend == 'true'
    uses: ./.github/workflows/_reusable-quality-frontend.yml
    secrets: inherit

  env-lint:
    name: Env Lint
    needs: detect-changes
    if: needs.detect-changes.outputs.env-examples == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install dotenv-linter
        run: python -m pip install --upgrade "dotenv-linter>=0.5.0,<0.6.0"
      - name: Lint env files
        run: dotenv-linter api/.env.example web/.env.example

  # ════════════════════════════════════════════════════════════
  # Stage 2: Build (Conditional, Parallel)
  # ════════════════════════════════════════════════════════════
  db-migration-check:
    name: DB Migration Check
    needs: [detect-changes, backend-quality]
    if: |
      always() &&
      needs.detect-changes.outputs.migrations == 'true' &&
      (needs.backend-quality.result == 'success' || needs.backend-quality.result == 'skipped')
    uses: ./.github/workflows/db-migration-check.yml
    secrets: inherit

  build-backend:
    name: Build Backend
    needs: [detect-changes, backend-quality]
    if: |
      always() &&
      needs.detect-changes.outputs.backend == 'true' &&
      (needs.backend-quality.result == 'success' || needs.backend-quality.result == 'skipped')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-uv
        with:
          working-directory: api
          python-version: "3.12"
      - name: Build package
        run: echo "Backend build placeholder (add Docker/package build here)"
        working-directory: api

  build-frontend:
    name: Build Frontend
    needs: [detect-changes, frontend-quality]
    if: |
      always() &&
      needs.detect-changes.outputs.frontend == 'true' &&
      (needs.frontend-quality.result == 'success' || needs.frontend-quality.result == 'skipped')
    uses: ./.github/workflows/_reusable-quality-frontend.yml
    with:
      run-build: true
    secrets: inherit

  # ════════════════════════════════════════════════════════════
  # Stage 3: Integration Tests (Future)
  # ════════════════════════════════════════════════════════════
  integration-tests:
    name: Integration Tests
    needs: [build-backend, build-frontend]
    if: |
      always() &&
      (needs.build-backend.result == 'success' || needs.build-backend.result == 'skipped') &&
      (needs.build-frontend.result == 'success' || needs.build-frontend.result == 'skipped')
    runs-on: ubuntu-latest
    steps:
      - name: Placeholder for E2E tests
        run: echo "Integration tests placeholder (add Playwright/Cypress here)"

  # ════════════════════════════════════════════════════════════
  # Final: Status Report
  # ════════════════════════════════════════════════════════════
  pipeline-status:
    name: Pipeline Status
    needs:
      [
        detect-changes,
        backend-quality,
        frontend-quality,
        db-migration-check,
        build-backend,
        build-frontend,
        integration-tests,
        env-lint,
      ]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Check pipeline status
        run: |
          echo "## Pipeline Status Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Backend Quality | ${{ needs.backend-quality.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend Quality | ${{ needs.frontend-quality.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Env Lint | ${{ needs.env-lint.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| DB Migration Check | ${{ needs.db-migration-check.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Backend Build | ${{ needs.build-backend.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend Build | ${{ needs.build-frontend.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Integration Tests | ${{ needs.integration-tests.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY

          # Fail if any required job failed
          if [[ "${{ needs.backend-quality.result }}" == "failure" ]] || \
             [[ "${{ needs.frontend-quality.result }}" == "failure" ]] || \
             [[ "${{ needs.env-lint.result }}" == "failure" ]] || \
             [[ "${{ needs.db-migration-check.result }}" == "failure" ]] || \
             [[ "${{ needs.build-backend.result }}" == "failure" ]] || \
             [[ "${{ needs.build-frontend.result }}" == "failure" ]]; then
            echo "❌ Pipeline failed" >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "✅ Pipeline passed" >> $GITHUB_STEP_SUMMARY
          fi
